- name: Deploy Site
  hosts: all  # Replace with your target hosts or group name
  gather_facts: yes

  vars:
    repo_name: "test-ansible-deploy"
    repo_host: "github.com" # github.com / bitbucket.org
    repo_url: "{{ repo_host }}:ScottJohansen/{{ repo_name }}.git"  # Replace with your repository URL
    branch: "branch-2"
    repo_dir: "/var/www/repos/{{ repo_name }}"  # Directory where the .git folder will be
    work_tree_dir: "/var/www/vhosts/test2"  # Directory where the working tree will be
    apache_user: "apache" # Apache if running PHP FPM directly, 33 if running via Docker

  tasks:
    - include_tasks: tasks/generate_ssh_keypair.yml
    - include_tasks: tasks/git-deploy.yml

    - name: Composer install
      community.general.composer:
        command: install
        working_dir: "{{ work_tree_dir }}"
        executable: /opt/remi/{{ php_executable }}/root/usr/bin/php
        composer_executable: /usr/local/bin/composer
      environment:
        COMPOSER_HOME: /var/www/composer/
      become: yes
      become_user: apache